---
title: "Creating customised DNA reference databases - Merging databases"
author: "Jessica Chung /Melissa Carew"
date: "15/02/2024"
output: html_document
---

--------------------------------------------------------------------------------
# SECTION 4: Creating a complete reference library

# Step 1:  Merging data from different sources
We can now use refdb_merge to merge all data into a single database.

# mergeing all libraries into a single document
```{r}
all_db <- refdb::refdb_merge(priv_lib_clean, ncbi_data_clean, bold_data_clean, keep = "fields_shared")

rm(bold_data_clean)
rm(ncbi_data_clean)
rm(priv_lib_clean)
```

# adjust taxonomy across datasets
Ensures that the consist taxonomic classification is use in specified columns (Phyla to genus, leave out species as it removes interim names (specify columns). This should be used on the final dataset (with GB data included) for the taxonomic field of phylum, class, order, family, genus. Species need to be left out as this function will remove interim species names from the private database.

```{r}
all_db <- refdb::refdb_clean_tax_harmonize_nomenclature(all_db, 4:7)
head(all_db)
```

# remove duplicates between private, BOLD and NCBI GenBank datasets
```{r}
all_db <- refdb::refdb_filter_seq_duplicates(all_db)
```

# resolving issues from refdb in the final library
The final library will still have NA in some empty taxonomic columns as the refdb function removes 'na' within taxonomic names. The final .rds will need the NA's filtered out using code that only removes 'NA from entire cells.
Also, there are some strange additions to the end for species names from the 'remove extra' that should be removed these include:

# Step 1: remove 'NA' from empty cells, weird additions on species names and trim whitespaces remaining at the end of species names
```{r}
#remove "NA" in taxonomic information and replace with blank (this needs to be done so NA do not occur in the final reference library taxonomic assignments)

all_db[is.na(all_db)] <- ""

#replacing odd additions to the end of species names from refdb

all_db$species <- gsub("\\'", "",
           gsub("\\.\\.", "",
           gsub("\\+", "",
           gsub("./Se/", "",
           gsub("sp. -", "sp. ",
           gsub("\\:", "",
           gsub(".cf.", "",
           gsub("sp.-", "sp. ",
           gsub("_", "",
           gsub("/Amp", "",
           gsub("<>", "",
           gsub("\\  ", "", all_db$species))))))))))))

# remove trailing spaces in species names
trimws(all_db$species, "right")

# check that all samples have id's
#rows_with_empty_values <- all_db[all_db$id == "", , drop = FALSE]
#rows_with_empty_values <- bold_data_clean_Oct23[bold_data_clean_Oct23$sequenceID == "", , drop = FALSE]
print(rows_with_empty_values)
# fix control samples and add name
#bold_data_clean_Oct23[3425930, "sequenceID"] <- "control"
```

#Step 2: Fix outdated taxonomic names 
```{r}
# fix outdated taxonomic names (Changing Ancylidae to Planorbidae, Sphaeriidae to Pisidiidae, Corbiculidae to Cyrenidae, Brentidae to Nanophyidae)

all_db$family <- gsub("Ancylidae",
           "Planorbidae",
           gsub("Sphaeriidae",
           "Pisidiidae",
           gsub("Corbiculidae",
           "Cyrenidae",
           gsub("Brentidae",
           "Nanophyidae", all_db$family))))

# check changes should all be TRUE
#print (sum(str_detect(all_db$family, 'Ancylidae')) > 0)
#print (sum(str_detect(all_db$family, 'Sphaeriidae')) > 0)
#print (sum(str_detect(all_db$family, 'Corbiculidae')) > 0)
#print (sum(str_detect(all_db$family, 'Brentidae')) > 0)
```  

# align column names
```{r}
#change column header from 'DNA_seq' to 'sequence' for further analysis
colnames(all_db)[colnames(all_db) == "DNA_seq"] ="sequence"
```

# remove NCBI duplicates with different 'sp.' instead of taxonomic names
```{r}
# Filter rows with 'bold' in 'source'
bold_data <- all_db %>%
  filter(source == "BOLD")
private_data <- all_db %>%
  filter(source == "private")

# Filter rows with 'ncbi' in 'source' and sequence values different from 'bold'
ncbi_data <- all_db %>%
  filter(source == "NCBI" & !(sequence %in% bold_data$sequence) & !(sequence %in% private_data$sequence))

# Combine the bold and unique ncbi data
all_db <- rbind(private_data, bold_data, ncbi_data)
```


# targeted corrections based on feedback from using the library
```{r}
# further corrections
all_db[all_db$id == '6359493', 'species'] <- 'Austrolimnius victoriensis';
all_db[all_db$id == '6361430', 'species'] <- 'Austrolimnius victoriensis'; all_db[all_db$id == 'MG976205', 'species'] <- 'Sclerocyphon sp. B-ADU1898';
all_db[all_db$id == 'BR17Chir1', 'species'] <- 'Tanytarsini sp. B-AED8094';
all_db[all_db$id == '17457262', 'species'] <- 'Chironomidae sp.B-AEZ6316';
all_db[all_db$id == '12788717', 'species'] <- 'Chironomidae sp.B-AEC8525'; all_db[all_db$id == '8f2bff5317b4e64a06fa96f53d357235', 'species'] <- 'Chironomidae sp.B-AEC8525';
all_db[all_db$id == '17460089', 'species'] <- 'Chironomidae sp.B-AABA7844';
all_db[all_db$id == '13118299', 'species'] <- 'Chironomidae sp.B-AABA7844';
all_db[all_db$id == '13118390', 'species'] <- 'Chironomidae sp.B-AABA7844';
all_db[all_db$id == 'MCA5', 'species'] <- 'Cricotopus parbicinctus';
all_db[all_db$id == '4576080', 'species'] <- 'Chironomidaesp. B-ABX4803';
all_db[all_db$id == '8647267', 'species'] <- 'Chironomidae sp.B-ADC2294';
all_db[all_db$id == '4576666', 'species'] <- 'Chironomidae sp.B-ABX4818';
all_db[all_db$id == 'BR17Chir1', 'species'] <- 'Tanytarsini sp. B-AED8094';
all_db[all_db$id == '16531491', 'species'] <- 'Dolichopodidae sp. B-ADP0042';
all_db[all_db$id == 'MW051368', 'species'] <- 'Austrosimulium sp. B-AEH7071';
all_db[all_db$id == 'MG976103', 'species'] <- 'Coloburiscoides sp. B-ADW5046';
all_db[all_db$id == '3971802', 'species'] <- 'Garinjuga sp. B-AAU5082';
all_db[all_db$id == '6233940', 'species'] <- 'Koorrnonga sp.B-ABV9141';
all_db[all_db$id == '6233938', 'species'] <- 'Koorrnonga sp.B-ABV9141';
all_db[all_db$id == '6233937', 'species'] <- 'Koorrnonga sp.B-ABV9141';
all_db[all_db$id == '6233939', 'species'] <- 'Koorrnonga sp.B-ABV9141';
all_db[all_db$id == '6233936', 'species'] <- 'Koorrnonga sp.B-ABV9141';
all_db[all_db$id == 'MG976137', 'species'] <- 'Nousia sp. B-AAV4108';
all_db[all_db$id == '6233904', 'species'] <- 'Nousia sp. B-AAV4108';
all_db[all_db$id == '6233861', 'species'] <- 'Ulmerophlebia sp. AV1';
all_db[all_db$id == 'MG976088', 'species'] <- 'Agraptocorixa eurynome';
all_db[all_db$id == '4590851', 'species'] <- 'Corixidae sp. B-ABX8129';
all_db[all_db$id == '4595437', 'species'] <- 'Corixidae sp. B-ABX8129';
all_db[all_db$id == '4595441', 'species'] <- 'Corixidae sp. B-ABX8129';
all_db[all_db$id == '4590855', 'species'] <- 'Corixidae sp. B-ABX8129';
all_db[all_db$id == '4595424', 'species'] <- 'Corixidae sp. B-ABX8129';
all_db[all_db$id == '4590850', 'species'] <- 'Corixidae sp. B-ABX8129';
all_db[all_db$id == 'MG976157', 'species'] <- 'Acruroperla atra';
all_db[all_db$id == 'KY078201', 'species'] <- 'Trinotoperla montana/minor';
all_db[all_db$id == '4569851', 'species'] <- 'Trinotoperla montana/minor';
all_db[all_db$id == '6233606', 'species'] <- 'Trinotoperla montana/minor';
all_db[all_db$id == '4569848', 'species'] <- 'Trinotoperla montana/minor';
all_db[all_db$id == 'KX293264', 'species'] <- 'Costora sp. AV1';
all_db[all_db$id == 'MG976097', 'species'] <- 'Ethochorema turbidum';
all_db[all_db$id == 'KX296032', 'species'] <- 'Cheumatopsyche sp. AV2';
all_db[all_db$id == 'KX291371', 'species'] <- 'Cheumatopsyche sp. AV2';
all_db[all_db$id == 'KX293263', 'species'] <- 'Cheumatopsyche sp. AV2';
all_db[all_db$id == 'KX293048', 'species'] <- 'Cheumatopsyche sp. AV2';
all_db[all_db$id == 'AY380482', 'species'] <- 'Cheumatopsyche sp. AV2';
all_db[all_db$id == 'AY380481', 'species'] <- 'Cheumatopsyche sp. AV2';
all_db[all_db$id == '5023709', 'species'] <- 'Cheumatopsyche sp. AV2';
all_db[all_db$id == 'KX295942', 'species'] <- 'Smicrophylax sp. B-AAD1443';
all_db[all_db$id == '6234794', 'species'] <- 'Smicrophylax sp. B-AAD1443';
all_db[all_db$id == 'KX144793', 'species'] <- 'Hydroptila sp. B-AAW9405';
all_db[all_db$id == 'KX141429', 'species'] <- 'Hydroptila sp. B-AAW9405';
all_db[all_db$id == '4338508', 'species'] <- 'Hydroptila sp. B-AAW9405';
all_db[all_db$id == '9038366', 'species'] <- 'Hydroptila sp. B-AAW9405';
all_db[all_db$id == '9038366', 'genus'] <- 'Hydroptila';
all_db[all_db$id == 'KX296535', 'species'] <- 'Notalina sp. B-ABV8023';
all_db[all_db$id == 'KX293602', 'species'] <- 'Notalina sp. B-ABV8023';
all_db[all_db$id == 'KX293447', 'species'] <- 'Notalina sp. B-ABV8023';
all_db[all_db$id == '6360850', 'species'] <- 'Notalina sp. B-ABV8023';
all_db[all_db$id == '4402258', 'species'] <- 'Notalina sp. B-ABV8023';
all_db[all_db$id == '6360852', 'species'] <- 'Notalina sp. B-ABV8023';
all_db[all_db$id == '5247098', 'species'] <- 'Notalina sp. B-ABV8023';
all_db[all_db$id == 'MG976160', 'species'] <- 'Triplectides proximus';
all_db[all_db$id == 'KX295899', 'species'] <- 'Notalina spira';
all_db[all_db$id == 'KX293581', 'species'] <- 'Notalina spira';
all_db[all_db$id == '4410775', 'species'] <- 'Notalina spira';
all_db[all_db$id == '4410775', 'genus'] <- 'Notalina';
all_db[all_db$id == '4410775', 'species'] <- 'Notalina spira'
all_db[all_db$id == 'KX294852', 'species'] <- 'Archaeophylax sp. B-AAZ8934';
all_db[all_db$id == 'KX294544', 'species'] <- 'Archaeophylax sp. B-AAZ8934';
all_db[all_db$id == '4400570', 'species'] <- 'Archaeophylax sp. B-AAZ8934';
all_db[all_db$id == '4400593', 'species'] <- 'Archaeophylax sp. B-AAZ8934';
all_db[all_db$id == 'KX296618', 'species'] <- 'Aphilorheithrus sp. B-ABV8712';
all_db[all_db$id == 'KX291380', 'species'] <- 'Aphilorheithrus sp. B-ABV8712';
all_db[all_db$id == '5023736', 'species'] <- 'Aphilorheithrus sp. B-ABV8712';
all_db[all_db$id == '6360800', 'species'] <- 'Aphilorheithrus sp. B-ABV8712';
all_db[all_db$id == 'KX295243', 'species'] <- 'Austrheithrus glymma';
all_db[all_db$id == 'KX291359', 'species'] <- 'Austrheithrus glymma';
all_db[all_db$id == 'FJ263246', 'species'] <- 'Austrheithrus glymma';
all_db[all_db$id == '9038378', 'species'] <- 'Austrheithrus glymma';
all_db[all_db$id == 'OL420908', 'species'] <- 'Paratya australiensis';
all_db[all_db$id == '12825674', 'species'] <- 'Paratya australiensis';
all_db[all_db$id == '12825675', 'species'] <- 'Paratya australiensis';
all_db[all_db$id == 'MG310921', 'species'] <- 'Macrocyclops albidus';
all_db[all_db$id == '3337505', 'species'] <- 'Macrocyclops albidus';
all_db[all_db$id == '9732031', 'species'] <- 'Macrocyclops albidus';
all_db[all_db$id == 'MF458665', 'species'] <- 'Macrocyclops albidus';
all_db[all_db$id == '6931945', 'species'] <- 'Macrocyclops albidus';
all_db[all_db$id == 'MG310921', 'genus'] <- 'Macrocyclops';
all_db[all_db$id == 'MF458665', 'genus'] <- 'Macrocyclops';
all_db[all_db$id == '9732031', 'genus'] <- 'Macrocyclops';
all_db[all_db$id == '3337505', 'family'] <- 'Cyclopidae';
all_db[all_db$id == '3337505', 'genus'] <- 'Macrocyclops';
all_db[all_db$id == '6931945', 'genus'] <- 'Macrocyclops';
all_db[all_db$id == 'OQ603601', 'species'] <- 'Paracyclops fimbriatus';
all_db[all_db$id == '1630399', 'species'] <- 'Astrohydra japonica';
all_db[all_db$id == '1630399', 'genus'] <- 'Astrohydra';
all_db[all_db$id == 'MG976184', 'species'] <- 'Corbicula sp. B-ADJ1627';
all_db[all_db$family == 'Physidae', 'order'] <- 'Hygrophila';
all_db[all_db$genus == 'Posticobia', 'family'] <- 'Tateidae';
all_db[all_db$id == 'MK047681', 'species'] <- 'Prostoma graecense';
all_db[all_db$id == '12420306', 'species'] <- 'Prostoma graecense';
all_db[all_db$id == '3785720', 'species'] <- 'Prostoma graecense';
all_db[all_db$id == '3785720', 'species'] <- 'Prostoma graecense';
all_db[all_db$id == '5023678', 'species'] <- 'Conoesucus sp. B-ACC8592';
all_db[all_db$id == 'KX296160', 'species'] <- 'Conoesucus sp. B-ACC8592';
all_db[all_db$id == '6359490', 'species'] <- 'Austrolimnius sp. B-ACN2709';
all_db[all_db$id == '6361434', 'species'] <- 'Austrolimnius sp. B-ACN2709' ;

# substitutions
all_db$order <- gsub("Copepoda", "Hexanauplia", all_db$order)

all_db$species <- gsub("Craspedacusta sowerbyi", "Craspedacusta sowerbii",
          	gsub("Pisidium hallae /", "Pisidium sp. cf. hallae",
			gsub("Pisidium sp. /", "Pisidium sp. cf. hallae",
 			gsub("Pisidium sp. hallae", "Pisidium sp. cf. hallae", all_db$species))))

# records for deleting (wrong id's or incomplete taxonomy causes taxonomic assignment issues)

values_to_delete <- c("9045802", "6211936", "6211937", "7685744", "12440123", "4476585", "ON506903", "ON506899")

# Delete rows with specified values in the 'id' column
all_db <- all_db[!all_db$id %in% values_to_delete, ]
```


# export final library as a dataframe
```{r}
saveRDS(all_db, here::here("final_library/all_bold_priv_NCBI_final_clean_Nov23.rds"))
```

# OPTIONAL convert to fasta file for import to Geneious
```{r}
# files are too large to export in one go so need to be broken in to smaller parts.

# create a duplicate document to format for Geneious 
all_db2 <- all_db

# add a an underscore to species to replace space in species names (fasta files cannot have gaps)
all_db2$species <- gsub(" ",
           "_", all_db$species)

head(all_db2)

# export group 1
export <- all_db2[1:2000000, ] 

# save fasta 
refdb_export_dada2(export, here::here("geneious_library/final_lib_export_nov23_1of3.fasta", mode = "taxonomy"))

# remove files no longer needed
rm(export)

# export group 2
export2 <- all_db2[2000001:4000000, ] 

# save fasta 
refdb_export_dada2(export2, here::here("geneious_library/final_lib_export_nov23_2of3.fasta", mode = "taxonomy"))

# remove files no longer needed
rm(export2)

# export group 3 (adjust final row number to match the final record number)
export3 <- all_db2[4000000:XXXXXXXX, ] 

# save fasta 
refdb_export_dada2(export3, here::here("geneious_library/final_lib_export_nov23_3of3.fasta", mode = "taxonomy"))

# remove files no longer needed
rm(export3)
rm(all_db2)
```

